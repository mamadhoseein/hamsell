#!/bin/bash

# ================================================
#       Hamsell Management CLI Tool
# ------------------------------------------------
# Designed for simple execution without "sudo hamsell"
# ================================================

# --- Configuration ---
GIT_REPO_URL="https://github.com/mamadhoseein/hamsell.git"
PROJECT_DIR="hamsell"
VENV_DIR="myenv"
WEB_SERVICE_NAME="config_bot_web"
BOT_SERVICE_NAME="config_bot"

# Project root path (Moved to /opt/ for better system compatibility)
PROJECT_ROOT="/opt" 
PROJECT_PATH="${PROJECT_ROOT}/${PROJECT_DIR}"
VENV_PATH="${PROJECT_PATH}/${VENV_DIR}"
PYTHON_PATH="${VENV_PATH}/bin/python3"

# Colors
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
CYAN="\033[0;36m"
BLUE="\033[0;34m"
NC="\033[0m"

# --- Helper Functions ---

# (ØªØ±ÙÙ†Ø¯ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ)
clear_all() {
    printf '\n%.0s' {1..100}
}

# (ØªØ§Ø¨Ø¹ ØªÙˆÙ‚Ù)
pause_for_user() {
    echo -e "\n${YELLOW}Press [Enter] to return to the menu...${NC}"
    read
}

# --- (ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©) ---
# Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± Ø¯Ø³ØªÙˆØ±ÛŒ Ú†Ú© Ùˆ Ø§ØµÙ„Ø§Ø­ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
fix_service_paths() {
    echo -e "${CYAN}ðŸ”§ Verifying service file paths...${NC}"
    local WEB_FILE="/etc/systemd/system/${WEB_SERVICE_NAME}.service"
    local BOT_FILE="/etc/systemd/system/${BOT_SERVICE_NAME}.service"
    local CHANGED=0

    # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ Ø³Ø±ÙˆÛŒØ³ ÙˆØ¨
    if [ -f "$WEB_FILE" ]; then
        if grep -q "/root/hamsell" "$WEB_FILE"; then
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' "$WEB_FILE"
            CHANGED=1
            echo -e "${GREEN}âœ… Fixed path in Web service.${NC}"
        fi
    fi

    # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ Ø³Ø±ÙˆÛŒØ³ Ø±Ø¨Ø§Øª
    if [ -f "$BOT_FILE" ]; then
        if grep -q "/root/hamsell" "$BOT_FILE"; then
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' "$BOT_FILE"
            CHANGED=1
            echo -e "${GREEN}âœ… Fixed path in Bot service.${NC}"
        fi
    fi

    # Ø§Ú¯Ø± ØªØºÛŒÛŒØ±ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯ØŒ systemd Ø±Ø§ Ø±ÛŒÙ„ÙˆØ¯ Ú©Ù†
    if [ $CHANGED -eq 1 ]; then
        echo -e "${YELLOW}Reloading systemd daemon...${NC}"
        sudo systemctl daemon-reload
    fi
}
# --- (Ù¾Ø§ÛŒØ§Ù† ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯) ---

# ------------------------------------------------
# Main Service Control Functions (Requires SUDO internal)
# ------------------------------------------------

control_service() {
    local SERVICE=$1
    local ACTION=$2
    local SERVICE_NAME=""
    local DISPLAY_NAME=""

    case "$SERVICE" in
        bot) SERVICE_NAME="${BOT_SERVICE_NAME}.service"; DISPLAY_NAME="Telegram Bot";;
        web) SERVICE_NAME="${WEB_SERVICE_NAME}.service"; DISPLAY_NAME="Web Panel";;
        *) echo -e "${RED}Error: Invalid service!${NC}"; return 1;;
    esac

    echo -e "${YELLOW}âš™ï¸ Executing [${ACTION}] on ${DISPLAY_NAME}...${NC}"
    sudo systemctl "$ACTION" "$SERVICE_NAME" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… ${DISPLAY_NAME} successfully ${ACTION}ed.${NC}"
    else
        echo -e "${RED}âŒ Failed! Checking status...${NC}"
        systemctl status "$SERVICE_NAME" --no-pager -n 5
    fi
}

# ------------------------------------------------
# Dependency Management Function (Includes Pillow)
# ------------------------------------------------

install_deps() {
    echo -e "${YELLOW}ðŸ Setting up Python Virtual Environment and Dependencies...${NC}"
    
    cd "${PROJECT_PATH}" || { echo -e "${RED}Error: Project directory not found at ${PROJECT_PATH}${NC}"; return 1; }
    
    if [ ! -d "$VENV_PATH" ]; then
        echo -e "${YELLOW}Virtual environment not found. Creating it now.${NC}"
        sudo python3 -m venv "${VENV_PATH}"
    fi

    (
        source "${VENV_PATH}/bin/activate"
        echo -e "${CYAN}Installing core dependencies...${NC}"
        pip install -q --upgrade pip
        pip install -q gunicorn flask qrcode requests routeros_api pyrogram TgCrypto Pillow || {
            echo -e "${RED}âŒ FATAL ERROR: Failed to install Python packages!${NC}";
            deactivate
            return 1
        }
        deactivate
    )

    echo -e "${GREEN}âœ… All Python dependencies successfully installed.${NC}"
    echo -e "${CYAN}Applying changes and restarting Web Panel...${NC}"
    sudo systemctl daemon-reload
    sudo systemctl restart ${WEB_SERVICE_NAME}.service
    echo -e "${GREEN}âœ… Dependencies installed and Web Panel restarted.${NC}"
}

# ------------------------------------------------
# Core Application Functions
# ------------------------------------------------

update_app() {
    echo -e "${YELLOW}ðŸ”„ Starting application code update...${NC}"
    cd "${PROJECT_PATH}" || { echo -e "${RED}Error: Project directory not found!${NC}"; return 1; }

    control_service bot stop
    control_service web stop
    echo -e "${CYAN}2. Pulling latest code from Git...${NC}"
    sudo git pull origin main
    install_deps # Update dependencies
    control_service bot restart
    control_service web restart
    echo -e "${GREEN}ðŸŽ‰ Update complete. ${NC}"
}

install() {
    if [ -e "$PROJECT_PATH" ]; then
        echo -e "${YELLOW}Project folder already exists. Running cleanup first.${NC}"
        cleanup
    fi

    echo -e "${YELLOW}ðŸš€ 1. Installing server dependencies...${NC}"
    sudo apt update > /dev/null 2>&1
    sudo apt install -y python3 python3-pip python3-venv git > /dev/null 2>&1

    echo -e "${YELLOW}ðŸ“¥ 2. Cloning project from Git...${NC}"
    cd "${PROJECT_ROOT}" || exit
    sudo git clone "$GIT_REPO_URL" || { echo -e "${RED}Error cloning project!${NC}"; exit 1; }
    sudo chown -R root:root "${PROJECT_PATH}"
    
    install_deps || { exit 1; } # Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø³Ø±ÙˆÛŒØ³ ÙˆØ¨ Ø±Ø§ Ù‡Ù… Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯

    echo -e "${YELLOW}âš™ï¸ 4. Deploying Web Installer Service...${NC}"

    # Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ø³Ø±ÙˆÛŒØ³ Ø§ÙˆÙ„ÛŒÙ‡ (Ù…ÙˆÙ‚Øª) Ø¨Ø±Ø§ÛŒ Ù†ØµØ¨â€ŒÚ©Ù†Ù†Ø¯Ù‡ ÙˆØ¨
    cat > /etc/systemd/system/${WEB_SERVICE_NAME}.service << EOL
[Unit]
Description=hamsell Web Installer
After=network.target

[Service]
User=root
WorkingDirectory=${PROJECT_PATH}
ExecStart=${PYTHON_PATH} -m gunicorn --workers 1 --bind 0.0.0.0:5000 "web_dashboard:app"
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOL
    
    # Ø±ÛŒÙ„ÙˆØ¯ Ùˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ù†Ù‡Ø§ÛŒÛŒ (Ú©Ù‡ ØªÙˆØ³Ø· install_deps Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø¨ÙˆØ¯)
    sudo systemctl daemon-reload
    sudo systemctl restart ${WEB_SERVICE_NAME}.service
    
    IP_ADDR=$(hostname -I | awk '{print $1}' | head -n 1)

    echo
    echo -e "${GREEN}ðŸŽ‰ Initial Setup Complete!${NC}"
    echo -e "Please open your browser and navigate to:"
    echo
    echo -e "  ${YELLOW}http://${IP_ADDR}:5000/install${NC}"
    echo
    echo -e "Use default admin/admin credentials for the *first* login."
}

cleanup() {
    echo -e "${RED}ðŸ›‘ Starting Cleanup Process...${NC}"
    echo -e "${RED}1. Stopping and removing systemd services...${NC}"
    control_service web stop
    control_service bot stop
    
    sudo rm -f /etc/systemd/system/${WEB_SERVICE_NAME}.service
    sudo rm -f /etc/systemd/system/${BOT_SERVICE_NAME}.service
    sudo systemctl daemon-reload

    echo -e "${RED}2. Removing project folder and virtual environment...${NC}"
    sudo rm -rf "${PROJECT_PATH}"
    
    echo -e "${GREEN}âœ… Cleanup complete.${NC}"
}


# ------------------------------------------------
# Main Menu Logic
# ------------------------------------------------
main_menu() {
    clear_all 
    echo -e "\n${BLUE}========================================${NC}"
    echo -e "${CYAN} ðŸ¤– Hamsell CLI Management Tool ðŸ¤– ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo -e "    ${GREEN}1${NC}) ðŸš€ ${CYAN}Full Install${NC} (From Scratch)"
    echo -e "    ${GREEN}2${NC}) ðŸ“¦ ${CYAN}Install Dependencies${NC} (Fix missing modules)"
    echo -e "    ${GREEN}3${NC}) ðŸ”„ ${CYAN}Update Project Code${NC} (Pull & Restart)"
    echo -e "    ${GREEN}4${NC}) ðŸ”„ ${CYAN}Restart All Services${NC}"
    echo -e "    ${GREEN}5${NC}) âš™ï¸ ${CYAN}Check Service Status${NC}"
    echo -e "    ${GREEN}6${NC}) ðŸ›‘ ${CYAN}Stop All Services${NC}"
    echo -e "    ${RED}7${NC}) ðŸ—‘ï¸ ${RED}Cleanup Project${NC} (Delete All)"
    echo -e "    ${GREEN}0${NC}) Exit"
    echo -e "${BLUE}========================================${NC}"
    read -rp "Enter your choice: " CHOICE

    case "$CHOICE" in
        1) 
            clear_all
            install 
            pause_for_user
            ;;
        2) 
            clear_all
            fix_service_paths # <--- Ø§ØµÙ„Ø§Ø­ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©
            install_deps 
            pause_for_user
            ;;
        3) 
            clear_all
            fix_service_paths # <--- Ø§ØµÙ„Ø§Ø­ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©
            update_app 
            pause_for_user
            ;;
        4) 
            clear_all
            fix_service_paths # <--- Ø§ØµÙ„Ø§Ø­ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©
            control_service bot restart
            control_service web restart
            pause_for_user
            ;;
        5) 
            clear_all
            fix_service_paths # <--- Ø§ØµÙ„Ø§Ø­ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©
            systemctl status ${BOT_SERVICE_NAME}.service --no-pager -n 5
            systemctl status ${WEB_SERVICE_NAME}.service --no-pager -n 5
            pause_for_user
            ;;
        6) 
            clear_all
            fix_service_paths # <--- Ø§ØµÙ„Ø§Ø­ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©
            control_service bot stop
            control_service web stop
            pause_for_user
            ;;
        7) 
            clear_all
            read -rp "âš ï¸ Are you sure you want to delete everything? (yes/no): " CONFIRM
            if [[ "$CONFIRM" == "yes" ]]; then
                cleanup
            else
                echo -e "${YELLOW}Cleanup operation cancelled.${NC}"
            fi
            pause_for_user
            ;;
        0) 
            clear_all
            exit 0 
            ;;
        *) 
            clear_all
            echo -e "${RED}Invalid option!${NC}"
            pause_for_user
            ;;
    esac
    main_menu
}

# ------------------------------------------------
# Execution Entry Point
# ------------------------------------------------

main_menu
