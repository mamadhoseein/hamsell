#!/bin/bash

# ================================================
#       Hamsell Management CLI Tool
# ------------------------------------------------
# Designed for simple execution without "sudo hamsell"
# ================================================

# --- Configuration ---
GIT_REPO_URL="https://github.com/mamadhoseein/hamsell.git"
PROJECT_DIR="hamsell"
VENV_DIR="myenv"
WEB_SERVICE_NAME="config_bot_web"
BOT_SERVICE_NAME="config_bot"

# Project root path (Moved to /opt/ for better system compatibility)
PROJECT_ROOT="/opt" 
PROJECT_PATH="${PROJECT_ROOT}/${PROJECT_DIR}"
VENV_PATH="${PROJECT_PATH}/${VENV_DIR}"
PYTHON_PATH="${VENV_PATH}/bin/python3"

# Colors
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
CYAN="\033[0;36m"
BLUE="\033[0;34m"
NC="\033[0m"

# --- Helper Functions ---

# (ÿ™ÿ∫€å€åÿ±: ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá ÿØÿ≥ÿ™Ÿàÿ± reset)
# ÿß€åŸÜ ÿØÿ≥ÿ™Ÿàÿ± ŸÅÿßÿµŸÑŸá‚ÄåŸáÿß€å ÿÆÿßŸÑ€å ÿ±ÿß ÿ≠ÿ∞ŸÅ ŸÖ€å‚Äå⁄©ŸÜÿØÿå ÿßŸÖÿß ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ÿßÿ≥⁄©ÿ±ŸàŸÑ ÿ¥ŸÖÿß ÿ±ÿß Ÿæÿß⁄© ŸÜÿÆŸàÿßŸáÿØ ⁄©ÿ±ÿØ
clear_all() {
    reset
}

# (ÿ™ÿßÿ®ÿπ ÿ™ŸàŸÇŸÅ)
pause_for_user() {
    echo -e "\n${YELLOW}Press [Enter] to return to the menu...${NC}"
    read
}

# ------------------------------------------------
# Main Service Control Functions
# ------------------------------------------------

control_service() {
    local SERVICE=$1
    local ACTION=$2
    local SERVICE_NAME=""
    local DISPLAY_NAME=""

    case "$SERVICE" in
        bot) SERVICE_NAME="${BOT_SERVICE_NAME}.service"; DISPLAY_NAME="Telegram Bot";;
        web) SERVICE_NAME="${WEB_SERVICE_NAME}.service"; DISPLAY_NAME="Web Panel";;
        *) echo -e "${RED}Error: Invalid service!${NC}"; return 1;;
    esac

    echo -e "${YELLOW}‚öôÔ∏è Executing [${ACTION}] on ${DISPLAY_NAME}...${NC}"
    sudo systemctl "$ACTION" "$SERVICE_NAME" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ ${DISPLAY_NAME} successfully ${ACTION}ed.${NC}"
    else
        echo -e "${RED}‚ùå Failed! Checking status...${NC}"
        systemctl status "$SERVICE_NAME" --no-pager -n 5
    fi
}

# ------------------------------------------------
# Dependency Management Function
# ------------------------------------------------

install_deps() {
    echo -e "${YELLOW}üêç Setting up Python Virtual Environment and Dependencies...${NC}"
    
    cd "${PROJECT_PATH}" || { echo -e "${RED}Error: Project directory not found at ${PROJECT_PATH}${NC}"; return 1; }
    
    if [ ! -d "$VENV_PATH" ]; then
        echo -e "${YELLOW}Virtual environment not found. Creating it now.${NC}"
        sudo python3 -m venv "${VENV_PATH}"
    fi

    (
        source "${VENV_PATH}/bin/activate"
        echo -e "${CYAN}Installing core dependencies...${NC}"
        pip install -q --upgrade pip
        pip install -q gunicorn flask qrcode requests routeros_api pyrogram TgCrypto Pillow || {
            echo -e "${RED}‚ùå FATAL ERROR: Failed to install Python packages!${NC}";
            deactivate
            return 1
        }
        deactivate
    )
    echo -e "${GREEN}‚úÖ Python dependencies successfully installed.${NC}"
}

# ------------------------------------------------
# Core Application Functions
# ------------------------------------------------

update_app() {
    echo -e "${YELLOW}üîÑ Starting application code update...${NC}"
    cd "${PROJECT_PATH}" || { echo -e "${RED}Error: Project directory not found!${NC}"; return 1; }

    # ÿ™ŸàŸÇŸÅ ÿ≥ÿ±Ÿà€åÿ≥‚ÄåŸáÿß ŸÇÿ®ŸÑ ÿßÿ≤ ÿ¢ŸæÿØ€åÿ™
    sudo systemctl stop ${WEB_SERVICE_NAME}.service
    sudo systemctl stop ${BOT_SERVICE_NAME}.service
    
    echo -e "${CYAN}2. Pulling latest code from Git...${NC}"
    sudo git pull origin main
    
    # ŸÜÿµÿ® ŸÜ€åÿßÿ≤ŸÖŸÜÿØ€å‚ÄåŸáÿß (ÿ®ÿØŸàŸÜ ÿ±€åÿ≥ÿ™ÿßÿ±ÿ™)
    install_deps
    
    echo -e "${GREEN}üéâ Update complete. Ready for restart.${NC}"
}

install() {
    if [ -e "$PROJECT_PATH" ]; then
        echo -e "${YELLOW}Project folder already exists. Running cleanup first.${NC}"
        cleanup
    fi

    echo -e "${YELLOW}üöÄ 1. Installing server dependencies...${NC}"
    sudo apt update > /dev/null 2>&1
    sudo apt install -y python3 python3-pip python3-venv git > /dev/null 2>&1

    echo -e "${YELLOW}üì• 2. Cloning project from Git...${NC}"
    cd "${PROJECT_ROOT}" || exit
    sudo git clone "$GIT_REPO_URL" || { echo -e "${RED}Error cloning project!${NC}"; exit 1; }
    sudo chown -R root:root "${PROJECT_PATH}"
    
    # ŸÜÿµÿ® ŸÜ€åÿßÿ≤ŸÖŸÜÿØ€å‚ÄåŸáÿß
    install_deps || { exit 1; }

    echo -e "${YELLOW}‚öôÔ∏è 4. Deploying Web Installer Service...${NC}"

    # ÿ≥ÿßÿÆÿ™ ŸÅÿß€åŸÑ ÿ≥ÿ±Ÿà€åÿ≥ ÿßŸàŸÑ€åŸá (ŸÖŸàŸÇÿ™) ÿ®ÿ±ÿß€å ŸÜÿµÿ®‚Äå⁄©ŸÜŸÜÿØŸá Ÿàÿ®
    cat > /etc/systemd/system/${WEB_SERVICE_NAME}.service << EOL
[Unit]
Description=hamsell Web Installer
After=network.target

[Service]
User=root
WorkingDirectory=${PROJECT_PATH}
ExecStart=${PYTHON_PATH} -m gunicorn --workers 1 --bind 0.0.0.0:5000 "web_dashboard:app"
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOL
    
    sudo systemctl daemon-reload
    sudo systemctl restart ${WEB_SERVICE_NAME}.service
    
    IP_ADDR=$(hostname -I | awk '{print $1}' | head -n 1)

    echo
    echo -e "${GREEN}üéâ Initial Setup Complete!${NC}"
    echo -e "Please open your browser and navigate to:"
    echo
    echo -e "  ${YELLOW}http://${IP_ADDR}:5000/install${NC}"
    echo
    echo -e "Use default admin/admin credentials for the *first* login."
}

cleanup() {
    echo -e "${RED}üõë Starting Cleanup Process...${NC}"
    echo -e "${RED}1. Stopping and removing systemd services...${NC}"
    sudo systemctl stop ${WEB_SERVICE_NAME}.service 2>/dev/null
    sudo systemctl stop ${BOT_SERVICE_NAME}.service 2>/dev/null
    
    sudo rm -f /etc/systemd/system/${WEB_SERVICE_NAME}.service
    sudo rm -f /etc/systemd/system/${BOT_SERVICE_NAME}.service
    sudo systemctl daemon-reload

    echo -e "${RED}2. Removing project folder and virtual environment...${NC}"
    sudo rm -rf "${PROJECT_PATH}"
    
    echo -e "${GREEN}‚úÖ Cleanup complete.${NC}"
}


# ------------------------------------------------
# Main Menu Logic
# ------------------------------------------------
main_menu() {
    clear_all 
    echo -e "\n${BLUE}========================================${NC}"
    echo -e "${CYAN} ü§ñ Hamsell CLI Management Tool ü§ñ ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo -e "    ${GREEN}1${NC}) üöÄ ${CYAN}Full Install${NC} (From Scratch)"
    echo -e "    ${GREEN}2${NC}) üì¶ ${CYAN}Install Dependencies & Fix Paths${NC}"
    echo -e "    ${GREEN}3${NC}) üîÑ ${CYAN}Update Project Code${NC} (Pull & Restart)"
    echo -e "    ${GREEN}4${NC}) üîÑ ${CYAN}Fix & Restart All Services${NC}"
    echo -e "    ${GREEN}5${NC}) ‚öôÔ∏è ${CYAN}Check Service Status${NC}"
    echo -e "    ${GREEN}6${NC}) üõë ${CYAN}Stop All Services${NC}"
    echo -e "    ${RED}7${NC}) üóëÔ∏è ${RED}Cleanup Project${NC} (Delete All)"
    echo -e "    ${GREEN}0${NC}) Exit"
    echo -e "${BLUE}========================================${NC}"
    read -rp "Enter your choice: " CHOICE

    case "$CHOICE" in
        1) 
            clear_all
            install 
            pause_for_user
            ;;
        2) 
            clear_all
            echo -e "${CYAN}Installing Python dependencies...${NC}"
            install_deps # (ŸÜÿµÿ® Ÿæ⁄©€åÿ¨‚ÄåŸáÿß)
            
            echo -e "\n${YELLOW}Now fixing service paths and restarting...${NC}"
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' /etc/systemd/system/config_bot_web.service
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' /etc/systemd/system/config_bot.service
            sudo systemctl daemon-reload
            sudo systemctl restart ${WEB_SERVICE_NAME}.service
            sudo systemctl restart ${BOT_SERVICE_NAME}.service
            echo -e "${GREEN}‚úÖ All services fixed and restarted.${NC}"
            
            pause_for_user
            ;;
        3) 
            clear_all
            update_app # (ÿ¥ÿßŸÖŸÑ ⁄Ø€åÿ™ ŸæŸàŸÑ Ÿà ŸÜÿµÿ® Ÿæ⁄©€åÿ¨‚ÄåŸáÿß)

            echo -e "\n${YELLOW}Fixing paths and restarting all services...${NC}"
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' /etc/systemd/system/config_bot_web.service
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' /etc/systemd/system/config_bot.service
            sudo systemctl daemon-reload
            sudo systemctl restart ${WEB_SERVICE_NAME}.service
            sudo systemctl restart ${BOT_SERVICE_NAME}.service
            echo -e "${GREEN}‚úÖ All services fixed and restarted.${NC}"

            pause_for_user
            ;;
        4) 
            clear_all
            echo -e "${YELLOW}Fixing paths and restarting all services...${NC}"
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' /etc/systemd/system/config_bot_web.service
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' /etc/systemd/system/config_bot.service
            sudo systemctl daemon-reload
            sudo systemctl restart ${WEB_SERVICE_NAME}.service
            sudo systemctl restart ${BOT_SERVICE_NAME}.service
            echo -e "${GREEN}‚úÖ All services fixed and restarted.${NC}"
            
            pause_for_user
            ;;
        5) 
            clear_all
            # ÿßŸàŸÑ ÿßÿµŸÑÿßÿ≠ ⁄©ŸÜ ÿ®ÿπÿØ Ÿàÿ∂ÿπ€åÿ™ ÿ±ÿß ŸÜÿ¥ÿßŸÜ ÿ®ÿØŸá
            echo -e "${YELLOW}Fixing paths before checking status...${NC}"
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' /etc/systemd/system/config_bot_web.service
            sudo sed -i 's|/root/hamsell|/opt/hamsell|g' /etc/systemd/system/config_bot.service
            sudo systemctl daemon-reload > /dev/null 2>&1
            
            echo -e "${CYAN}--- Bot Status ---${NC}"
            systemctl status ${BOT_SERVICE_NAME}.service --no-pager -n 5
            echo -e "${CYAN}--- Web Status ---${NC}"
            systemctl status ${WEB_SERVICE_NAME}.service --no-pager -n 5
            pause_for_user
            ;;
        6) 
            clear_all
            control_service bot stop
            control_service web stop
            pause_for_user
            ;;
        7) 
            clear_all
            read -rp "‚ö†Ô∏è Are you sure you want to delete everything? (yes/no): " CONFIRM
            if [[ "$CONFIRM" == "yes" ]]; then
                cleanup
            else
                echo -e "${YELLOW}Cleanup operation cancelled.${NC}"
            fi
            pause_for_user
            ;;
        0) 
            clear_all
            exit 0 
            ;;
        *) 
            clear_all
            echo -e "${RED}Invalid option!${NC}"
            pause_for_user
            ;;
    esac
    main_menu
}

# ------------------------------------------------
# Execution Entry Point
# ------------------------------------------------

main_menu
